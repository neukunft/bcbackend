-------- Reference --------INSERT INTO import.reference (name)SELECT distinct modelFROM import.referencetype;-------- Reference Series --------INSERT INTO import.reference_series (series, fk_reference)SELECT sub.series, sub.reference_idFROM (         SELECT distinct (model, series)                            as distinct,                         model                                      as reference_name,                         cast(replace(series, '.0', '') as integer) as series,                         import.reference.id                        as reference_id         FROM import.referencetype                  LEFT JOIN import.reference on import.reference.name = model) sub;-------- Reference Series-Model --------INSERT INTO import.reference_series_model(metal_identifier, fk_series)SELECT sub.referenceadditon, sub.series_idFROM (         SELECT distinct (model, series, referenceadditon) as distinct, referenceadditon, sub.series_id         FROM import.referencetype                  LEFT JOIN (SELECT (r.name, rs.series) as mapper, rs.id as series_id                             FROM import.reference_series rs                                      LEFT JOIN import.reference r on rs.fk_reference = r.id) sub                            on mapper = (cast(model as varchar(10)), cast(substring(series, 1, 1) as smallint))     ) sub;-------- Reference Type --------UPDATE import.referencetypeSET fk_reference_series_model = sub.model_idFROM (         SELECT rm.id as model_id, concat(r.name, rs.series, rm.metal_identifier) as series_model_name         FROM import.reference_series_model rm                  LEFT JOIN import.reference_series rs on rs.id = rm.fk_series                  LEFT JOIN import.reference r on r.id = rs.fk_reference     ) subWHERE sub.series_model_name = concat(model, cast(substring(series, 1, 1) as integer), referenceadditon);---------------------------------------------------------------        REF       -----------------------------------------------------------------------  Abbreviation --------INSERT INTO public.vwe_abbreviation    (id, abbreviation, translation)SELECT uuid(id),       abbreviation.abbreviation,       translationFROM import.abbreviation;-------- AuctionHouse --------INSERT INTO public.auction_house    (id, name)SELECT uuid(id),       nameFROM import.auction_house;-------- AuctionHouseLocation --------INSERT INTO public.auction_house_location    (id, location, fk_auction_house)SELECT uuid(id),       location,       uuid(fk_auctionhouse)FROM import.auction_house_location;-------- Reference --------INSERT INTO public.maker (name)VALUES ('Patek Philippe'),       ('Rolex'),       ('Cartier'),       ('Vacheron Constantin'),       ('Audemars Piguet'),       ('Omega'),       ('Jaeger LeCoultre'),       ('Piaget'),       ('IWC'),       ('Longines'),       ('Swiss'),       ('Franck Muller'),       ('Breitling'),       ('Panerai'),       ('Chopard'),       ('Ulysse Nardin'),       ('Heuer'),       ('Corum'),       ('Breguet'),       ('Zenith'),       ('Hublot'),       ('A. Lange & Söhne'),       ('Roger Dubuis'),       ('F.P. Journe'),       ('Unsigned'),       ('Blancpain'),       ('Glashütte Original'),       ('Richard Mille'),       ('Girard-Perregaux'),       ('Gübelin'),       ('International Watch Co.'),       ('Universal'),       ('Harry Winston'),       ('Tudor'),       ('Gérald Genta'),       ('Bulgari'),       ('Van Cleef & Arpels'),       ('Urban Jürgensen'),       ('Montblanc'),       ('Movado'),       ('Continental'),       ('Chronoswiss'),       ('Daniel Roth'),       ('Tiffany & Co.'),       ('Bell & Ross'),       ('Bovet'),       ('Chanel'),       ('H. Moser & Cie'),       ('Parmigiani Fleurier'),       ('MB&F'),       ('Urwerk'),       ('Greubel Forsey'),       ('LeCoultre'),       ('Graham'),       ('Namiki'),       ('Gerald Genta'),       ('Jaquet Droz'),       ('French');-------- Reference --------INSERT INTO public.reference    (id, name, fk_maker)SELECT r.id, r.name, m.idFROM import.reference r,     public.maker mWHERE m.name = 'Patek Philippe';-------- Reference Series --------INSERT INTO public.reference_series    (id, fk_reference, series)SELECT id,       fk_reference,       seriesFROM import.reference_series;-------- Reference Model --------INSERT INTO public.reference_series_model    (id, fk_reference_series, metal_identifier)SELECT id,       fk_series,       metal_identifierFROM import.reference_series_model;-------- Reference Variant --------INSERT INTO public.reference_variant(id, reference_variant_original_name, reference_class, manufactured_from, manufactured_from_precision, manufactured_to, manufactured_to_precision, quantity_produced, shape, common_name, common_name_detailed, type, caliber, dimensions, thickness, width, weight, lugs_pdt, diameter, quantity_found, comment, manufactured_from_addition, manufactured_from_is_exact, manufactured_to_addition, manufactured_to_is_exact, produced_addition, variant1, variant2, is_verified, jewels, case_description, key, gauge, bezel, dial_color, index_color, hands_color, hands_style, availability, dial_kind, index_style, index_design, index_numerals, index_symbol, index_sertissage, fk_reference_series_model, last_retail, retail_2008, variant_name)SELECT uuid(import.referencetype.id),       concat(model, variant1, referenceadditon, ' ', variant2),       class,       CAST(manufacturedfrom AS DATE),       CAST(UPPER(manufacturedfromprecision) AS date_precision),       CAST(manufacturedto AS DATE),       CAST(UPPER(manufacturedtoprecision) AS date_precision),       CAST(replace(produced, ',', '.') AS DOUBLE PRECISION),       shape,       "common name",       "common name detailed",       type,       calibre,       size,       CAST(replace(thickness, ',', '.') AS DOUBLE PRECISION),       CAST(replace(width, ',', '.') AS DOUBLE PRECISION),       CAST(replace(weight, ',', '.') AS DOUBLE PRECISION),       lugs_pdt,       CAST(replace(diameter, ',', '.') AS DOUBLE PRECISION),       CAST(CAST(replace(found, ',', '.') AS DECIMAL) AS INTEGER),       --referenceadditon,       import.referencetype.comment,       manufacturedfromaddition,       CAST(CAST(CAST(replace(manufacturedfromisexact, ',', '.') AS DECIMAL) AS INTEGER) AS BOOLEAN),       manufacturedtoaddition,       CAST(CAST(CAST(replace(manufacturedtoisexact, ',', '.') AS DECIMAL) AS INTEGER) AS BOOLEAN),       producedaddition,       --model,       variant1,       variant2,       CAST(CAST(CAST(replace(isVerified, ',', '.') AS DECIMAL) AS INTEGER) AS BOOLEAN),       f.jewels,       f."case",       f.key,       f.gauge,       f.bezel,       f.dialcolor,       f."index color",       f."hands color",       f."hands style",       f.availability,       f."dial kind",       f."index style",       f."index design",       f."index numerals",       f."index symbol",       f."index sertissage",       fk_reference_series_model,       lastretailorappearance,       retailprice2008,       clear_variant_nameFROM import.referencetype         LEFT JOIN import.feature f on f.id = import.referencetype.fk_features;-------- Adjust Keymaker --------UPDATE reference_variantSET key = km.id || ' - ' || km.nameFROM import.keymaker kmWHERE key = cast(km.id AS TEXT);-------- Retail Price --------INSERT INTO public.retail_price (fk_reference_variant, price, date, date_precision, currency)SELECT uuid(fk_referencevariant),       CAST(replace(retailprice, '.0', '') as integer),       CAST(retailpricedate as date),       CAST(upper(retailpricedateprecision) as date_precision),       CAST(retailpricecurrency as currencycode)FROM import.retail_priceWHERE fk_referencevariant IN (    SELECT upper(text(id))    FROM public.reference_variant)  and (import.retail_price.canBeDeleted != '1.0' or canbedeleted isnull);-------- Watch --------INSERT INTO public.watch(id, fk_reference_variant, case_number, comment, has_been_changed, is_fake, movement_number, is_unknown_exact_movement, movement_lower_range, movement_upper_range, is_unknown_exact_case, case_lower_range, case_upper_range, is_verified, quantity_produced)SELECT uuid(id),       uuid(fk_model) as fk_model,       CAST(CAST(replace(casenumber, ',', '.') AS DECIMAL) AS INTEGER)::TEXT,       comment,       CAST(CAST(CAST(replace(haschangedcase, ',', '.') AS DECIMAL) AS INTEGER) AS BOOLEAN),       CAST(CAST(CAST(replace(isfake, ',', '.') AS DECIMAL) AS INTEGER) AS BOOLEAN),       CAST(CAST(replace(movementnumber, ',', '.') AS DECIMAL) AS INTEGER)::TEXT,       CAST(CAST(CAST(replace(isunknownexactmovement, ',', '.') AS DECIMAL) AS INTEGER) AS BOOLEAN),       CAST(CAST(replace(movementlowerrange, ',', '.') AS DECIMAL) AS INTEGER)::TEXT,       CAST(CAST(replace(movementupperrange, ',', '.') AS DECIMAL) AS INTEGER)::TEXT,       CAST(CAST(CAST(replace(isunknownexactcase, ',', '.') AS DECIMAL) AS INTEGER) AS BOOLEAN),       CAST(CAST(replace(caselowerrange, ',', '.') AS DECIMAL) AS INTEGER)::TEXT,       CAST(CAST(replace(caseupperrange, ',', '.') AS DECIMAL) AS INTEGER)::TEXT,       CAST(CAST(CAST(replace(isVerified, ',', '.') AS DECIMAL) AS INTEGER) AS BOOLEAN),       CAST(CAST(replace(numberproduced, ',', '.') AS DECIMAL) AS SMALLINT)FROM import.watchWHERE fk_model IN (    SELECT upper(text(id))    FROM public.reference_variant)ON CONFLICT do nothing;INSERT INTO public.vwe_watch_feature-------- WatchFeature --------    (id, fk_watch, fk_abbreviation)SELECT uuid(id),       uuid(fk_watch),       uuid(fk_abbreviation)FROM import.watch_featureWHERE fk_watch IN (    SELECT upper(text(id))    FROM public.watch);-------- Auction --------ALTER TABLE import.auction    ADD COLUMN dateFromCalc text;ALTER TABLE import.auction    ADD COLUMN dateToCalc text;UPDATE import.auctionSET dateFromCalc = CASE                       WHEN datefrom isnull THEN date                       ELSE datefrom    ENDWHERE auction.dateFromCalc isnull;UPDATE import.auctionSET dateToCalc = CASE                     WHEN dateto isnull THEN date                     ELSE dateto    ENDWHERE auction.dateToCalc isnull;INSERT INTO public.vwe_auction(id, fk_auction_house_location, date, date_from, date_to, date_precision, date_used_for_price_calculation, internal_auction_name)SELECT uuid(id),       uuid(fk_auctionhouselocation),       CAST(dateforsearch AS DATE),       CAST(datefrom AS DATE),       CAST(dateto AS DATE),       CAST(UPPER(dateprecision) AS date_precision),       CAST(dateusedforpricecalculation AS DATE),       internalauctionnameFROM import.Auctionwhere id in (    select fk_auction    from import.auction_lot    where fk_watch in (        select upper(text(id))        from public.watch    ));-------- AuctionLot --------INSERT INTO public.vwe_auction_lot(id, fk_auction, fk_watch, additional_information, comment, currency, has_not_been_sold, is_empty_price, is_extract_of_archives, lot_number, lot_number_addition, price, price_in_usd, was_withdrawn, is_verified, estimate_from_in_usd, estimate_to_in_usd, estimate_from, estimate_to)SELECT uuid(id),       uuid(fk_auction),       uuid(fk_watch),       CAST(CAST(CAST(replace(additionalinformation, ',', '.') AS DECIMAL) AS INTEGER) AS BOOLEAN),       comment,       CAST(currency AS currencycode),       CAST(CAST(CAST(replace(hasnotbeensold, ',', '.') AS DECIMAL) AS INTEGER) AS BOOLEAN),       CAST(CAST(CAST(replace(isemptyprice, ',', '.') AS DECIMAL) AS INTEGER) AS BOOLEAN),       CAST(CAST(CAST(replace(isextractofarchives, ',', '.') AS DECIMAL) AS INTEGER) AS BOOLEAN),       CAST(CAST(replace(lotnumber, ',', '.') AS DECIMAL) AS INTEGER),       lotnumberaddition,       CAST(replace(price, ',', '.') AS DECIMAL),       CAST(replace(priceinusd, ',', '.') AS DECIMAL),       CAST(CAST(CAST(replace(waswithdran, ',', '.') AS DECIMAL) AS INTEGER) AS BOOLEAN),       CAST(CAST(CAST(replace(isVerified, ',', '.') AS DECIMAL) AS INTEGER) AS BOOLEAN),       CAST(replace(estimatefrom, ',', '.') AS DECIMAL),       CAST(replace(estimateto, ',', '.') AS DECIMAL),       CAST(replace(estimatefrom, ',', '.') AS DECIMAL),       CAST(replace(estimateto, ',', '.') AS DECIMAL)FROM import.auction_lotwhere fk_watch in (    select upper(text(id))    from public.watch)  and import.auction_lot.isobsolete isnull;INSERT INTO public.vwe_condition (id, fk_auctionlot, date, bracelet_type, case_condition, case_rating,                                  certificate_retailer,                                  description,                                  dial_condition, dial_rating, has_box, has_bracelet, has_certificate, has_extra_item,                                  movement_condition,                                  movement_rating)SELECT uuid(id),       uuid(fk_auctionlot),       CAST(date AS date),       bracelettype,       "case",       CAST(caserating AS smallint),       certificateretailer,       description,       dial,       CAST(dialrating AS smallint),       CAST(CAST(CAST(replace(hasbox, ',', '.') AS DECIMAL) AS INTEGER) AS BOOLEAN),       CAST(CAST(CAST(replace(hasbracelet, ',', '.') AS DECIMAL) AS INTEGER) AS BOOLEAN),       CAST(CAST(CAST(replace(hascertificate, ',', '.') AS DECIMAL) AS INTEGER) AS BOOLEAN),       CAST(CAST(CAST(replace(hasextraitem, ',', '.') AS DECIMAL) AS INTEGER) AS BOOLEAN),       movement,       CAST(movementrating AS SMALLINT)FROM import.Conditionwhere fk_auctionlot in (    select upper(text(id))    from public.vwe_auction_lot);-------- EventDescription --------INSERT INTO public.event_description    (id, short_description, description)SELECT uuid(id),       short,       descriptionFROM import.event_description;-------- Event --------INSERT INTO public.event(id, fk_watch, fk_auction_lot, fk_event_description, date, date_precision)SELECT uuid(id),       uuid(fk_watch),       uuid(fk_auctionlot),       uuid(fk_eventdescription),       CAST(date as DATE),       CAST(upper(dateprecision) AS date_precision)FROM import.eventWHERE fk_watch IN (    SELECT upper(text(id))    FROM public.watch)  AND (            fk_auctionlot IN (            SELECT upper(text(id))            FROM public.vwe_auction_lot) or (fk_auctionlot isnull)    )  AND CAST(CAST(CAST(replace(import.event.isObsolete, ',', '.') AS DECIMAL) AS INTEGER) AS BOOLEAN) = FALSE;UPDATE public.reference_variantSET variant_name = split_part(common_name_detailed, E'\n', 1)WHERE reference_variant.variant_name IS NULL;UPDATE public.reference_variantSET is_official_variant = FALSEWHERE reference_variant.is_official_variant IS NULL;UPDATE public.reference_variantSET is_relevant_statistics = TRUEWHERE reference_variant.is_relevant_statistics IS NULL;---------------------------------------------------------------       NO REF     ----------------------------------------------------------------- PREPARE DATAupdate import.no_ref_watchset case_number = (    select replace(string_agg(t.arr[1], ''), 'c', '')    FROM regexp_matches(features, 'c\d{4,8}', 'i') t(arr))where no_ref_watch.case_number isnull;-- Import dataINSERT INTO no_reference_info (id, heading, form, class, start, "end", quantity, shape, model, so_called, type, jewels,                               calibre, found, mvt_number, comment, "case", size, height, weight, key, lugs_pdt, gauge,                               bezel, dial, code, stern, idx, hands, more_comment, retail_08, last_retail_or_appearance,                               y2017, y2015_2016, y2013_2014, y2011_2012, y2009_2010, y2008, y2007, y2006, y2005, y2004,                               y2003, y2002, y2001, y2000, y1999, y1998, y1997, y1996, y1995, y1994, y1993, y1992,                               y1991, y1990, y1988, y1986, y1984, y1982, y1980, y1977, y1974, y1970, y1965, y1960,                               y1955, y1950, y1945, y1940, y1935, y1930, y1920, y1910, y1900, y1875, y1850)SELECT cast(id as uuid),       heading,       form,       class,       start,       "end",       quantity,       shape,       model,       so_called,       type,       jewels,       calibre,       found,       mvt_number,       comment,       "case",       size,       height,       weight,       key,       lugs_pdt,       gauge,       bezel,       dial,       code,       stern,       idx,       hands,       more_comment,       retail_08,       last_retail_or_appearance,       y2017,       y2015_2016,       y2013_2014,       y2011_2012,       y2009_2010,       y2008,       y2007,       y2006,       y2005,       y2004,       y2003,       y2002,       y2001,       y2000,       y1999,       y1998,       y1997,       y1996,       y1995,       y1994,       y1993,       y1992,       y1991,       y1990,       y1988,       y1986,       y1984,       y1982,       y1980,       y1977,       y1974,       y1970,       y1965,       y1960,       y1955,       y1950,       y1945,       y1940,       y1935,       y1930,       y1920,       y1910,       y1900,       y1875,       y1850FROM import.no_ref_info;--todo featuresINSERT INTO public.watch (id, fk_no_reference_info, movement_number, case_number, comment, needs_manual_verification)SELECT cast(nrw.id as uuid),       cast(nrw.fk_no_ref as uuid),       movement,       case_number,       old_notation,       cast(replace(nri.duplicate, 'keep', '1') as boolean)FROM import.no_ref_watch nrw         LEFT JOIN import.no_ref_info nri on nrw.fk_no_ref = nri.idON CONFLICT (movement_number, case_number) do update    SET fk_no_reference_info = excluded.fk_no_reference_info;update referenceset name = cast(name as integer)where name like '0%%%'  and cast(name as integer) > 0;-- move 'Sold' Events 12hours to make sorting of 'made' and 'sold' logicalupdate eventset date = date + interval '12 hours'where fk_event_description = '998949ff-9f03-4165-a53e-64b7e305e688';